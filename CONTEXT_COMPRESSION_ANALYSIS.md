# ä¸Šä¸‹æ–‡å‹ç¼©æœºåˆ¶åˆ†æä¸ä¼˜åŒ–å»ºè®®

## ğŸ“Š é—®é¢˜ç°çŠ¶

ä»å®é™…è¿è¡Œæ—¥å¿—åˆ†æï¼š
```
Message compression completed: 2998889 -> 151583 tokens (reduction: 94.9%)
```

å•æ¬¡Deep Researchä¸Šä¸‹æ–‡è¾¾åˆ°**300ä¸‡tokens**ï¼Œå‹ç¼©åçº¦15ä¸‡tokensã€‚

## ğŸ” Tokenæ¶ˆè€—åˆ†æ

### Tokenæ¥æºå æ¯”ä¼°ç®—

| æ¥æº | æ¯æ¬¡å æ¯” | ç´¯è®¡30æ¬¡æœç´¢ | è¯´æ˜ |
|------|---------|------------|------|
| **raw_content** | 30,000 tokens/æ¬¡ | ~900,000 tokens | **ä¸»è¦å…ƒå‡¶** - å®Œæ•´ç½‘é¡µåŸå§‹å†…å®¹ |
| contentæ‘˜è¦ | 3,000 tokens/æ¬¡ | ~90,000 tokens | Tavilyæä¾›çš„ç²¾ç‚¼æ‘˜è¦ |
| AIåˆ†æå†…å®¹ | 10,000 tokens/æ­¥ | ~100,000 tokens | æ¯ä¸ªresearchæ­¥éª¤çš„findings |
| å†å²æ¶ˆæ¯ | - | ~50,000 tokens | å¯¹è¯å†å²ç´¯ç§¯ |
| å›¾ç‰‡æè¿° | 500 tokens/æ¬¡ | ~15,000 tokens | å›¾ç‰‡AIæè¿° |
| å…ƒæ•°æ® | - | ~10,000 tokens | å·¥å…·è°ƒç”¨ã€çŠ¶æ€ç­‰ |

**æ€»è®¡ï¼šçº¦ 1,165,000 tokensï¼ˆä»…ä¼°ç®—ï¼Œå®é™…å¯èƒ½å› å†…å®¹é•¿åº¦æ³¢åŠ¨ï¼‰**

### raw_contentçš„é—®é¢˜

1. **åŒ…å«å¤§é‡æ— ç”¨ä¿¡æ¯**ï¼š
   - ç½‘é¡µå¯¼èˆªæ ã€é¡µè„šã€å¹¿å‘Š
   - HTMLæ ‡è®°æ®‹ç•™
   - é‡å¤å†…å®¹

2. **ä¸contenté«˜åº¦é‡å¤**ï¼š
   - Tavilyå·²ç»æä¾›äº†ç²¾ç‚¼çš„`content`å­—æ®µ
   - `raw_content`é€šå¸¸åªæ˜¯å†—ä½™ä¿¡æ¯

3. **tokenæ¶ˆè€—æƒŠäºº**ï¼š
   - å•ä¸ªç½‘é¡µraw_content: 5,000-20,000 tokens
   - ç›¸æ¯”contentæ‘˜è¦: 500-1,000 tokens
   - **è†¨èƒ€æ¯”ä¾‹ï¼š10-20å€**

## ğŸ› ï¸ å½“å‰ä¸Šä¸‹æ–‡å‹ç¼©æœºåˆ¶

### å·¥ä½œåŸç†ï¼ˆsrc/utils/context_manager.pyï¼‰

#### 1. **åˆ†å±‚ä¿æŠ¤ç­–ç•¥**

```python
def _intelligent_compress(self, messages):
    # ç­–ç•¥1: ä¿æŠ¤å‰Næ¡æ¶ˆæ¯ï¼ˆç³»ç»Ÿæç¤ºè¯ç­‰ï¼‰
    prefix_count = self.preserve_prefix_message_count  # é»˜è®¤3
    
    # ç­–ç•¥2: æ»‘åŠ¨çª—å£ä¿æŠ¤æœ€è¿‘æ¶ˆæ¯
    recent_messages = messages[-self.sliding_window_size:]  # é»˜è®¤5
    
    # ç­–ç•¥3: å‹ç¼©ä¸­é—´æ—§æ¶ˆæ¯
    older_messages = messages[prefix_count:-sliding_window_size]
```

#### 2. **å‹ç¼©æ–¹æ³•**

å¯¹äºæ—§æ¶ˆæ¯ï¼ˆç‰¹åˆ«æ˜¯ToolMessageï¼‰ï¼š

**A. JSONæ™ºèƒ½å‹ç¼©**ï¼ˆæ–°å¢ä¿®å¤ï¼‰
```python
def _try_compress_json(self, content, max_tokens):
    # è¯†åˆ«JSONæ ¼å¼çš„å·¥å…·ç»“æœ
    data = json.loads(content)
    
    if isinstance(data, list):
        # ä¿ç•™é¦–å°¾å…ƒç´ ï¼Œåˆ é™¤ä¸­é—´
        return [data[0], data[-1]]
    
    elif isinstance(data, dict):
        # ä¿ç•™å…³é”®å­—æ®µï¼šurl, title, scoreç­‰
        return {k: v for k, v in data.items() if k in priority_fields}
```

**B. åŸºäºè§„åˆ™çš„æ‘˜è¦**
```python
def _summarize_message(self, message, max_tokens=300):
    # æå–<finding>æ ‡ç­¾å†…å®¹
    findings = re.findall(r'<finding>(.*?)</finding>', content)
    
    # ä¿ç•™é¦–å°¾ï¼Œå‹ç¼©ä¸­é—´
    summary = [findings[0], f"[... {len(findings)-2} findings omitted ...]", findings[-1]]
```

**C. ç›´æ¥æˆªæ–­**
```python
def _truncate_message_content(self, message, max_tokens):
    char_limit = max_tokens * 2
    return content[:char_limit] + "... [truncated]"
```

#### 3. **Tokené¢„ç®—åˆ†é…**

```python
# 60%é¢„ç®—ç»™æ—§æ¶ˆæ¯ï¼Œ40%ç»™æœ€è¿‘æ¶ˆæ¯
older_budget = available_tokens * 0.6
recent_budget = available_tokens * 0.4
```

#### 4. **å‹ç¼©æ•ˆæœ**

ä»å®é™…è¿è¡Œçœ‹ï¼š
- å‹ç¼©å‰ï¼š2,998,889 tokens
- å‹ç¼©åï¼š151,583 tokens
- **å‹ç¼©ç‡ï¼š94.9%** âœ…

è¿™å·²ç»æ˜¯éå¸¸é«˜æ•ˆçš„å‹ç¼©ï¼ä½†æ ¹æºé—®é¢˜æ˜¯è¾“å…¥äº†å¤ªå¤šæ— ç”¨æ•°æ®ã€‚

## âœ… ä¼˜åŒ–å»ºè®®

### å»ºè®®1ï¼šç¦ç”¨raw_contentï¼ˆå¼ºçƒˆæ¨èï¼‰

**é…ç½®æ–¹æ³•**ï¼š
åœ¨`conf.yaml`ä¸­æ·»åŠ ï¼š

```yaml
SEARCH_ENGINE:
  engine: tavily
  include_raw_content: false  # ç¦ç”¨raw_content
  include_images: true
  max_content_length_per_page: 5000  # é™åˆ¶contenté•¿åº¦
  min_score_threshold: 0.4  # è¿‡æ»¤ä½è´¨é‡ç»“æœ
```

**é¢„æœŸæ•ˆæœ**ï¼š
- Tokenæ¶ˆè€—å‡å°‘ **60-70%**
- ä»300ä¸‡é™è‡³çº¦90-120ä¸‡tokens
- æœç´¢è´¨é‡**å‡ ä¹ä¸å—å½±å“**ï¼ˆcontentå·²ç»è¶³å¤Ÿï¼‰

**æ˜¯å¦æœ‰å¿…è¦åŒ…å«raw_contentï¼Ÿ**

âŒ **å¤§å¤šæ•°æƒ…å†µä¸‹ä¸éœ€è¦**ï¼š
- Tavilyçš„`content`å­—æ®µå·²ç»æ˜¯AIä¼˜åŒ–çš„æ‘˜è¦
- å¯¹äºdeep researchï¼Œæ‘˜è¦ä¿¡æ¯å·²è¶³å¤Ÿ
- raw_contentåªä¼šå¸¦æ¥å™ªéŸ³å’Œtokenæµªè´¹

âœ… **ä»…åœ¨ä»¥ä¸‹æƒ…å†µéœ€è¦**ï¼š
- éœ€è¦æå–ç‰¹å®šç»†èŠ‚ï¼ˆå¦‚è¡¨æ ¼æ•°æ®ã€ä»£ç ç‰‡æ®µï¼‰
- éœ€è¦éªŒè¯å¼•ç”¨çš„å‡†ç¡®æ€§
- contentæ‘˜è¦è´¨é‡ä¸ä½³

### å»ºè®®2ï¼šä¼˜åŒ–æœç´¢åå¤„ç†

```yaml
SEARCH_ENGINE:
  engine: tavily
  include_raw_content: false
  max_content_length_per_page: 3000  # æ¯é¡µé™åˆ¶3000å­—ç¬¦
  min_score_threshold: 0.5  # æé«˜è´¨é‡é˜ˆå€¼
```

### å»ºè®®3ï¼šå‡å°‘æœç´¢æ¬¡æ•°

è°ƒæ•´é…ç½®ï¼š
```yaml
max_search_results: 2  # ä»3å‡å°‘åˆ°2
max_step_num: 5  # é™åˆ¶ç ”ç©¶æ­¥éª¤æ•°
```

### å»ºè®®4ï¼šä½¿ç”¨æ›´å¤§token limitçš„æ¨¡å‹

```yaml
BASIC_MODEL:
  model: "openai/gpt-5-nano"
  token_limit: 250000  # å½“å‰
  
# æ”¹ä¸ºï¼š
BASIC_MODEL:
  model: "google/gemini-2.5-pro"  # æ”¯æŒæ›´å¤§ä¸Šä¸‹æ–‡
  token_limit: 2000000  # å‡å°‘å‹ç¼©é¢‘ç‡
```

## ğŸ“ˆ ä¼˜åŒ–æ•ˆæœé¢„æµ‹

| ä¼˜åŒ–æªæ–½ | Tokenå‡å°‘ | è´¨é‡å½±å“ | æ¨èåº¦ |
|---------|----------|---------|-------|
| ç¦ç”¨raw_content | -60% | â­â­â­â­â­ å‡ ä¹æ— å½±å“ | â­â­â­â­â­ |
| é™åˆ¶contenté•¿åº¦ | -10% | â­â­â­â­ è½»å¾®å½±å“ | â­â­â­â­ |
| æé«˜scoreé˜ˆå€¼ | -5% | â­â­â­â­â­ åè€Œæå‡è´¨é‡ | â­â­â­â­â­ |
| å‡å°‘æœç´¢ç»“æœæ•° | -15% | â­â­â­ ä¸­ç­‰å½±å“ | â­â­â­ |

**ç»„åˆä¼˜åŒ–é¢„æœŸ**ï¼š
- Tokenæ¶ˆè€—ï¼š300ä¸‡ â†’ **60-80ä¸‡** tokensï¼ˆå‡å°‘73-80%ï¼‰
- å‹ç¼©åï¼š15ä¸‡ â†’ **5-8ä¸‡** tokens
- ç ”ç©¶è´¨é‡ï¼š**å‡ ä¹ä¸å—å½±å“**ï¼Œç”šè‡³å› è¿‡æ»¤å™ªéŸ³è€Œæå‡

## ğŸ¯ æ¨èé…ç½®

```yaml
SEARCH_ENGINE:
  engine: tavily
  include_raw_content: false  # â­ æ ¸å¿ƒä¼˜åŒ–
  include_images: true
  include_image_descriptions: true
  max_content_length_per_page: 3000  # é™åˆ¶å•é¡µé•¿åº¦
  min_score_threshold: 0.5  # è¿‡æ»¤ä½è´¨é‡ç»“æœ
```

## ğŸ”§ ç°æœ‰å‹ç¼©æœºåˆ¶è¯„ä»·

### ä¼˜ç‚¹ âœ…
1. **å¤šå±‚ä¿æŠ¤**ï¼šä¿æŠ¤ç³»ç»Ÿæ¶ˆæ¯ã€æœ€è¿‘æ¶ˆæ¯
2. **æ™ºèƒ½è¯†åˆ«JSON**ï¼šæ–°å¢çš„JSONå‹ç¼©é¿å…ç ´åç»“æ„
3. **å‹ç¼©ç‡é«˜**ï¼š94.9%çš„å‹ç¼©ç‡å·²ç»å¾ˆä¼˜ç§€
4. **è‡ªé€‚åº”**ï¼šæ ¹æ®token budgetåŠ¨æ€è°ƒæ•´

### å¯æ”¹è¿›ä¹‹å¤„ ğŸ’¡
1. **æ›´æ¿€è¿›çš„ToolMessageå‹ç¼©**ï¼š
   - å½“å‰å¯¹ToolMessageå‹ç¼©åˆ°300 tokens
   - å¯ä»¥è¿›ä¸€æ­¥å‹ç¼©åˆ°100-150 tokens
   
2. **æ™ºèƒ½å»é‡**ï¼š
   - æ£€æµ‹é‡å¤çš„æœç´¢ç»“æœ
   - åˆå¹¶ç›¸ä¼¼å†…å®¹

3. **ä¼˜å…ˆçº§æ’åº**ï¼š
   - ä¿ç•™é«˜scoreçš„æœç´¢ç»“æœ
   - åˆ é™¤ä½scoreçš„å®Œæ•´å†…å®¹

4. **è¯­ä¹‰å‹ç¼©**ï¼š
   - ä½¿ç”¨å°æ¨¡å‹å¯¹é•¿æ–‡æœ¬åšè¯­ä¹‰æ‘˜è¦
   - è€Œä¸æ˜¯ç®€å•æˆªæ–­

## ğŸ“ æ€»ç»“

**é—®é¢˜æ ¹æº**ï¼š`include_raw_content: true` å¼•å…¥äº†å¤§é‡å†—ä½™æ•°æ®

**æœ€ä½³è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç«‹å³ç¦ç”¨`raw_content`ï¼ˆå‡å°‘60-70% tokenï¼‰
2. è®¾ç½®åˆç†çš„`max_content_length_per_page`
3. ç°æœ‰å‹ç¼©æœºåˆ¶å·²ç»å¾ˆä¼˜ç§€ï¼Œæ— éœ€å¤§æ”¹

**ç°æœ‰å‹ç¼©æœºåˆ¶è¿ä½œè‰¯å¥½**ï¼š
- åˆ†å±‚ä¿æŠ¤ç­–ç•¥åˆç†
- JSONæ™ºèƒ½å‹ç¼©ï¼ˆå·²ä¿®å¤bugï¼‰
- 94.9%å‹ç¼©ç‡ä¼˜ç§€

**å…³é”®è®¤çŸ¥**ï¼š
> ä¸Šä¸‹æ–‡å‹ç¼©æ˜¯æ²»æ ‡ä¸æ²»æœ¬ï¼Œåº”è¯¥ä»æºå¤´å‡å°‘æ— ç”¨æ•°æ®çš„å¼•å…¥ã€‚ç¦ç”¨raw_contentæ˜¯æœ€æœ‰æ•ˆçš„ä¼˜åŒ–æ‰‹æ®µã€‚

