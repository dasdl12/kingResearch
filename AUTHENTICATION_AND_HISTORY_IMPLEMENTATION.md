# ç”¨æˆ·è®¤è¯ä¸å¯¹è¯å†å²åŠŸèƒ½å®ç°æ–‡æ¡£

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

å®ç°å¤šç”¨æˆ·è®¤è¯å’Œå¯¹è¯å†å²ç®¡ç†åŠŸèƒ½ï¼Œç”¨æˆ·å¯ä»¥ï¼š
- æ³¨å†Œ/ç™»å½•è´¦å·
- æŸ¥çœ‹è‡ªå·±çš„å†å²ç ”ç©¶
- ç‚¹å‡»å†å²è®°å½•ç›´æ¥æŸ¥çœ‹å®Œæ•´çš„ç ”ç©¶æŠ¥å‘Šå’Œæµç¨‹ï¼ˆéå›æ”¾æ¨¡å¼ï¼‰
- åˆ é™¤è‡ªå·±çš„ç ”ç©¶è®°å½•
- æ•°æ®å®Œå…¨éš”ç¦»ï¼ˆç”¨æˆ·åªèƒ½çœ‹åˆ°è‡ªå·±çš„æ•°æ®ï¼‰

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. åç«¯è®¤è¯æ¨¡å— âœ…
- [x] JWT token ç”Ÿæˆå’ŒéªŒè¯ (`src/auth/jwt_handler.py`)
- [x] å¯†ç åŠ å¯†ï¼ˆbcryptï¼‰(`src/auth/password.py`)
- [x] FastAPI è®¤è¯ä¾èµ–æ³¨å…¥ (`src/auth/dependencies.py`)
- [x] è®¤è¯è¯·æ±‚/å“åº”æ¨¡å‹ (`src/server/auth_request.py`)

### 2. æ•°æ®åº“è®¾è®¡ âœ…
- [x] åˆ›å»ºç”¨æˆ·è¡¨ (users)
- [x] ä¿®æ”¹ research_replays è¡¨ï¼Œæ·»åŠ ï¼š
  - `user_id` - ç”¨æˆ·IDï¼ˆå¤–é”®ï¼‰
  - `is_completed` - æ˜¯å¦å®Œæˆ
  - `final_report` - å®Œæ•´æŠ¥å‘Š
  - `observations` - ç ”ç©¶è¿‡ç¨‹ï¼ˆJSONBï¼‰
  - `plan` - ç ”ç©¶è®¡åˆ’ï¼ˆJSONBï¼‰
  - `completed_at` - å®Œæˆæ—¶é—´
- [x] æ•°æ®åº“è¿ç§»è„šæœ¬ (`migrations/001_create_users_and_add_user_id.sql`)

### 3. Checkpointç®¡ç† âœ…
- [x] ä¿®æ”¹ `ChatStreamManager` ç±»
- [x] å®ç° `save_completed_research()` - **åªä¿å­˜å®Œæˆçš„ç ”ç©¶**
- [x] å®ç° `get_user_researches()` - è·å–ç”¨æˆ·ç ”ç©¶åˆ—è¡¨
- [x] å®ç° `get_research_report()` - è·å–å®Œæ•´ç ”ç©¶æ•°æ®ï¼ˆåŒ…æ‹¬observationså’Œplanï¼‰
- [x] å®ç° `delete_research()` - åˆ é™¤ç ”ç©¶ï¼ˆå¸¦æ‰€æœ‰æƒéªŒè¯ï¼‰
- [x] æ‰€æœ‰æ“ä½œéƒ½éªŒè¯user_idï¼Œç¡®ä¿æ•°æ®éš”ç¦»

### 4. ç ”ç©¶æµç¨‹é›†æˆ âœ…  
- [x] ä¿®æ”¹ `Configuration` ç±»ï¼Œæ·»åŠ  `thread_id` å’Œ `user_id` å­—æ®µ
- [x] ä¿®æ”¹ `reporter_node`ï¼Œåœ¨ç”ŸæˆæŠ¥å‘Šåè‡ªåŠ¨ä¿å­˜å®Œæ•´ç ”ç©¶æ•°æ®

## ğŸš§ å¾…å®Œæˆçš„å·¥ä½œ

### 5. API ç«¯ç‚¹ï¼ˆè¿›è¡Œä¸­ï¼‰â³
éœ€è¦åœ¨ `src/server/app.py` æ·»åŠ ï¼š

```python
# è®¤è¯ç›¸å…³
POST /api/auth/register  # ç”¨æˆ·æ³¨å†Œ
POST /api/auth/login     # ç”¨æˆ·ç™»å½•  
GET  /api/auth/me        # è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯

# ç ”ç©¶å†å²ç›¸å…³
GET  /api/researches                  # è·å–ç”¨æˆ·çš„ç ”ç©¶åˆ—è¡¨
GET  /api/research/{thread_id}        # è·å–å®Œæ•´ç ”ç©¶æ•°æ®ï¼ˆobservations + plan + reportï¼‰
DELETE /api/research/{thread_id}      # åˆ é™¤ç ”ç©¶

# ä¿®æ”¹ç°æœ‰æ¥å£
POST /api/chat/stream                 # æ·»åŠ user_idåˆ°config
```

### 6. å‰ç«¯å®ç° ğŸ“±
- [ ] åˆ›å»º AuthContext (`web/src/core/auth/context.tsx`)
- [ ] ç™»å½•/æ³¨å†Œé¡µé¢ (`web/src/app/auth/page.tsx`)
- [ ] ä¿®æ”¹å¯¹è¯åˆ—è¡¨ç»„ä»¶ (`web/src/app/settings/dialogs/conversations-dialog.tsx`)
  - æ˜¾ç¤ºç”¨æˆ·è‡ªå·±çš„ç ”ç©¶åˆ—è¡¨
  - ç‚¹å‡»æ—¶åŠ è½½å®Œæ•´æ•°æ®å¹¶ç›´æ¥å±•ç¤º
- [ ] ä¿®æ”¹chaté¡µé¢ï¼Œæ”¯æŒä»å†å²è®°å½•åŠ è½½å®Œæ•´state
- [ ] æ·»åŠ tokenåˆ°æ‰€æœ‰APIè¯·æ±‚

### 7. æ•°æ®å±•ç¤ºé€»è¾‘ ğŸ¨
**å…³é”®ç‚¹ï¼šä¸å›æ”¾æ¨¡å¼çš„åŒºåˆ«**

#### å›æ”¾æ¨¡å¼ï¼ˆç°æœ‰ï¼‰:
```
1. åŠ è½½replayæ–‡æœ¬æ–‡ä»¶
2. é€è¡Œè§£æSSEäº‹ä»¶
3. æ…¢æ…¢æ’­æ”¾ï¼Œæ¨¡æ‹Ÿå®æ—¶æ•ˆæœ
```

#### å†å²æŸ¥çœ‹æ¨¡å¼ï¼ˆæ–°åŠŸèƒ½ï¼‰:
```
1. è°ƒç”¨ GET /api/research/{thread_id}
2. è¿”å›å®Œæ•´æ•°æ®ï¼š
   {
     final_report: "...",
     observations: ["step1 result", "step2 result", ...],
     plan: { title: "...", steps: [...] },
     research_topic: "...",
     ...
   }
3. å‰ç«¯ç›´æ¥æ¸²æŸ“ï¼š
   - Activityé¢æ¿ï¼šæ˜¾ç¤ºæ‰€æœ‰observations
   - Reporté¢æ¿ï¼šæ˜¾ç¤ºfinal_report
   - ä¸éœ€è¦SSEæµå¼ä¼ è¾“
   - ç«‹å³æ˜¾ç¤ºæ‰€æœ‰å†…å®¹
```

## ğŸ“¦ ä¾èµ–åŒ…

éœ€è¦æ·»åŠ åˆ° `requirements.txt`:
```
passlib[bcrypt]>=1.7.4
PyJWT>=2.8.0
python-multipart>=0.0.6
```

## ğŸ”§ ç¯å¢ƒå˜é‡é…ç½®

åœ¨ `.env` æˆ–ç¯å¢ƒå˜é‡ä¸­æ·»åŠ ï¼š
```bash
# JWTå¯†é’¥ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨å¼ºéšæœºå­—ç¬¦ä¸²ï¼‰
JWT_SECRET_KEY=your-super-secret-key-change-this-in-production

# PostgreSQLè¿æ¥ï¼ˆå¦‚æœä½¿ç”¨PostgreSQLï¼‰
LANGGRAPH_CHECKPOINT_DB_URL=postgresql://user:password@localhost:5432/deerflow

# å¯ç”¨checkpointåŠŸèƒ½
LANGGRAPH_CHECKPOINT_SAVER=true
```

## ğŸ—„ï¸ æ•°æ®åº“è¿ç§»æ­¥éª¤

```bash
# 1. è¿æ¥åˆ°PostgreSQLæ•°æ®åº“
psql -d deerflow -U your_username

# 2. è¿è¡Œè¿ç§»è„šæœ¬
\i migrations/001_create_users_and_add_user_id.sql

# 3. éªŒè¯è¡¨ç»“æ„
\d users
\d research_replays
```

## ğŸ” è®¤è¯æµç¨‹

### æ³¨å†Œæµç¨‹:
```
1. ç”¨æˆ·æäº¤ï¼šusername, email, password
2. åç«¯ï¼š
   - éªŒè¯ç”¨æˆ·å/é‚®ç®±å”¯ä¸€æ€§
   - ä½¿ç”¨bcryptåŠ å¯†å¯†ç 
   - æ’å…¥usersè¡¨
   - ç”ŸæˆJWT token
3. è¿”å›ï¼štoken + user_id
4. å‰ç«¯ï¼šä¿å­˜tokenåˆ°localStorage
```

### ç™»å½•æµç¨‹:
```
1. ç”¨æˆ·æäº¤ï¼šusername (æˆ–email), password
2. åç«¯ï¼š
   - æŸ¥è¯¢ç”¨æˆ·
   - éªŒè¯å¯†ç 
   - ç”ŸæˆJWT token
3. è¿”å›ï¼štoken + user_id
4. å‰ç«¯ï¼šä¿å­˜tokenåˆ°localStorage
```

### APIè°ƒç”¨æµç¨‹:
```
1. å‰ç«¯ï¼šä»localStorageè¯»å–token
2. è¯·æ±‚å¤´ï¼šAuthorization: Bearer <token>
3. åç«¯ï¼šéªŒè¯tokenï¼Œæå–user_id
4. æ‰§è¡Œæ“ä½œï¼ˆè‡ªåŠ¨è¿‡æ»¤ç”¨æˆ·æ•°æ®ï¼‰
```

## ğŸ¬ å®Œæ•´ä½¿ç”¨æµç¨‹

### ç”¨æˆ·è§†è§’ï¼š

1. **é¦–æ¬¡ä½¿ç”¨**:
   ```
   è®¿é—®ç½‘ç«™ â†’ æ³¨å†Œè´¦å· â†’ ç™»å½•æˆåŠŸ â†’ è¿›å…¥ç ”ç©¶ç•Œé¢
   ```

2. **è¿›è¡Œç ”ç©¶**:
   ```
   è¾“å…¥ç ”ç©¶é—®é¢˜ â†’ ç­‰å¾…å®Œæˆ â†’ è‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“
   ï¼ˆä¿å­˜å†…å®¹ï¼šfinal_report + observations + plan + user_idï¼‰
   ```

3. **æŸ¥çœ‹å†å²**:
   ```
   ç‚¹å‡»"å¯¹è¯å†å²"å›¾æ ‡ â†’ çœ‹åˆ°è‡ªå·±çš„ç ”ç©¶åˆ—è¡¨ â†’ ç‚¹å‡»æŸä¸ªç ”ç©¶
   â†’ ç«‹å³å±•ç¤ºå®Œæ•´æŠ¥å‘Šå’Œç ”ç©¶æµç¨‹ï¼ˆactivity + reportï¼‰
   ```

4. **åˆ é™¤ç ”ç©¶**:
   ```
   åœ¨å†å²åˆ—è¡¨ä¸­ç‚¹å‡»åˆ é™¤ â†’ ç¡®è®¤ â†’ ä»æ•°æ®åº“åˆ é™¤
   ```

## ğŸ”’ å®‰å…¨è€ƒè™‘

1. **å¯†ç å®‰å…¨**: ä½¿ç”¨bcryptåŠ å¯†ï¼Œä¸å­˜å‚¨æ˜æ–‡
2. **Tokenå®‰å…¨**: JWTæœ‰æ•ˆæœŸ7å¤©ï¼Œä½¿ç”¨HTTPSä¼ è¾“
3. **æ•°æ®éš”ç¦»**: æ‰€æœ‰æŸ¥è¯¢éƒ½æ·»åŠ user_idè¿‡æ»¤
4. **SQLæ³¨å…¥**: ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
5. **XSSé˜²æŠ¤**: å‰ç«¯ä½¿ç”¨Reactè‡ªåŠ¨è½¬ä¹‰

## ğŸ“Š æ•°æ®å­˜å‚¨ç»“æ„

### research_replaysè¡¨ç»“æ„:
```sql
CREATE TABLE research_replays (
    id UUID PRIMARY KEY,
    thread_id VARCHAR(255),
    user_id UUID REFERENCES users(id),  -- å…³è”ç”¨æˆ·
    research_topic VARCHAR(500),
    report_style VARCHAR(50),
    final_report TEXT,                  -- æœ€ç»ˆæŠ¥å‘Š
    observations JSONB,                 -- ç ”ç©¶è¿‡ç¨‹ ["step1 result", "step2 result"]
    plan JSONB,                         -- ç ”ç©¶è®¡åˆ’ {title: "", steps: []}
    is_completed BOOLEAN,               -- åªæœ‰TRUEçš„æ‰æ˜¾ç¤º
    created_at TIMESTAMP,
    completed_at TIMESTAMP,
    ts TIMESTAMP
);
```

## ğŸ› æµ‹è¯•æ£€æŸ¥æ¸…å•

- [ ] ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½æ­£å¸¸
- [ ] ç”¨æˆ·ç™»å½•åŠŸèƒ½æ­£å¸¸
- [ ] TokenéªŒè¯æ­£å¸¸
- [ ] å®Œæˆç ”ç©¶åè‡ªåŠ¨ä¿å­˜
- [ ] åªèƒ½çœ‹åˆ°è‡ªå·±çš„ç ”ç©¶åˆ—è¡¨
- [ ] ç‚¹å‡»å†å²è®°å½•èƒ½æ­£ç¡®å±•ç¤ºå®Œæ•´æ•°æ®
- [ ] åˆ é™¤ç ”ç©¶åŠŸèƒ½æ­£å¸¸ï¼ˆå¸¦æ‰€æœ‰æƒéªŒè¯ï¼‰
- [ ] å¤šç”¨æˆ·æ•°æ®å®Œå…¨éš”ç¦»
- [ ] æœªç™»å½•ç”¨æˆ·æ— æ³•è®¿é—®å—ä¿æŠ¤æ¥å£

## ğŸ“ æ ¸å¿ƒä»£ç ä½ç½®

```
src/
â”œâ”€â”€ auth/                          # è®¤è¯æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ jwt_handler.py             # JWTå¤„ç†
â”‚   â”œâ”€â”€ password.py                # å¯†ç åŠ å¯†
â”‚   â””â”€â”€ dependencies.py            # è®¤è¯ä¾èµ–
â”œâ”€â”€ graph/
â”‚   â”œâ”€â”€ checkpoint.py              # âœ… ç ”ç©¶ä¿å­˜/è¯»å–ï¼ˆå·²å®Œæˆï¼‰
â”‚   â””â”€â”€ nodes.py                   # âœ… reporter_nodeä¿å­˜é€»è¾‘ï¼ˆå·²å®Œæˆï¼‰
â”œâ”€â”€ config/
â”‚   â””â”€â”€ configuration.py           # âœ… æ·»åŠ thread_idå’Œuser_idï¼ˆå·²å®Œæˆï¼‰
â”œâ”€â”€ server/
â”‚   â”œâ”€â”€ app.py                     # â³ APIç«¯ç‚¹ï¼ˆå¾…æ·»åŠ ï¼‰
â”‚   â””â”€â”€ auth_request.py            # âœ… è®¤è¯æ¨¡å‹ï¼ˆå·²å®Œæˆï¼‰
â””â”€â”€ migrations/
    â””â”€â”€ 001_create_users_and_add_user_id.sql  # âœ… æ•°æ®åº“è¿ç§»ï¼ˆå·²å®Œæˆï¼‰

web/src/
â”œâ”€â”€ core/
â”‚   â””â”€â”€ auth/
â”‚       â””â”€â”€ context.tsx            # â³ è®¤è¯ä¸Šä¸‹æ–‡ï¼ˆå¾…å®ç°ï¼‰
â””â”€â”€ app/
    â”œâ”€â”€ auth/
    â”‚   â””â”€â”€ page.tsx               # â³ ç™»å½•é¡µé¢ï¼ˆå¾…å®ç°ï¼‰
    â””â”€â”€ settings/dialogs/
        â””â”€â”€ conversations-dialog.tsx  # â³ å¯¹è¯å†å²ï¼ˆå¾…ä¿®æ”¹ï¼‰
```

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³æ‰§è¡Œæ•°æ®åº“è¿ç§»**
2. **å®ŒæˆAPIç«¯ç‚¹å®ç°**
3. **å®ç°å‰ç«¯è®¤è¯å’Œå†å²æŸ¥çœ‹**
4. **æµ‹è¯•å®Œæ•´æµç¨‹**

---

**é‡è¦æç¤º**: 
- âœ… **å·²å®ç°ä¿å­˜å®Œæ•´ç ”ç©¶æ•°æ®**ï¼ˆåŒ…æ‹¬observationså’Œplanï¼‰
- âœ… **åªä¿å­˜å·²å®Œæˆçš„ç ”ç©¶**ï¼ˆæœ‰final_reportçš„æ‰ä¿å­˜ï¼‰
- âš ï¸ **ç‚¹å‡»å†å²è®°å½•ç›´æ¥å±•ç¤ºï¼Œä¸æ˜¯å›æ”¾æ¨¡å¼**








